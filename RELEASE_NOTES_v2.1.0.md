# MCU Code Analyzer v2.1.0 Release Notes

## 🎉 版本发布信息
- **版本号**: v2.1.0
- **发布日期**: 2025-06-16
- **类型**: 功能增强版本

## 🚀 主要新功能

### 1. 在线Mermaid渲染系统重构
- ✅ **多API支持**: 支持多个在线mermaid渲染服务
- ✅ **智能编码**: 根据不同API自动选择最佳编码方式
- ✅ **备用机制**: 主API失败时自动切换到备用服务
- ✅ **网络诊断**: 内置网络连接和API可用性测试工具

### 2. 在线渲染服务测试工具
- 🔧 **mermaid_online_tester.py**: 全面测试各种在线mermaid渲染服务
- 🔧 **test_mermaid_ink.py**: 专门测试Mermaid.ink服务稳定性
- 🔧 **test_mermaid_live.py**: 测试Mermaid Live Editor API支持
- 📊 **详细报告**: 生成完整的测试报告和性能分析

### 3. 配置系统优化
- ⚙️ **灵活编码配置**: 支持base64、base64_url、zlib_base64等编码方式
- ⚙️ **超时控制**: 可配置的请求超时和重试机制
- ⚙️ **用户代理**: 可自定义User-Agent提高兼容性

## 🔧 技术改进

### 在线渲染引擎
```yaml
# 新的配置格式
mermaid:
  online:
    api_url: https://mermaid.ink/img/
    encoding: base64_url
    fallback_url: https://kroki.io/mermaid/png/
    max_retries: 2
    timeout: 10
```

### 智能编码选择
- **Mermaid.ink**: 使用URL安全base64编码
- **Kroki.io**: 使用zlib压缩+base64编码
- **其他服务**: 使用标准base64编码

### 错误处理增强
- 🛡️ **连接重置检测**: 自动识别网络连接问题
- 🛡️ **超时处理**: 智能超时重试机制
- 🛡️ **状态码分析**: 详细的HTTP状态码错误分析

## 🐛 问题修复

### 1. Mermaid渲染问题
- ❌ **修复**: 移除了不兼容的`<br/>`HTML标签
- ❌ **修复**: 解决了函数名换行导致的语法错误
- ❌ **修复**: 优化了长函数名的显示方式

### 2. 网络连接问题
- ❌ **修复**: 改进了网络错误的检测和处理
- ❌ **修复**: 添加了连接重置的自动重试机制
- ❌ **修复**: 优化了请求头设置提高兼容性

## 📊 性能优化

### 响应时间改进
- ⚡ **主API响应**: 平均1.3秒（Mermaid.ink测试结果）
- ⚡ **备用切换**: 失败检测时间缩短至5秒
- ⚡ **重试机制**: 智能重试避免不必要的等待

### 资源使用优化
- 💾 **内存使用**: 优化了图片缓存机制
- 💾 **网络带宽**: 改进了编码效率
- 💾 **CPU使用**: 减少了不必要的编码转换

## 🧪 测试覆盖

### 新增测试工具
1. **全面API测试**: 测试8个不同的在线mermaid服务
2. **稳定性测试**: 多次请求测试服务稳定性
3. **编码兼容性**: 测试不同编码方式的兼容性
4. **网络诊断**: 自动诊断网络连接问题

### 测试结果
- ✅ **Mermaid.ink**: 部分可用（成功率16.7%）
- ❌ **Kroki.io**: 超时问题
- ❌ **QuickChart.io**: 404错误
- ❌ **其他服务**: 各种连接问题

## 🔄 兼容性

### 向后兼容
- ✅ **配置文件**: 自动迁移旧配置格式
- ✅ **API接口**: 保持现有API不变
- ✅ **用户界面**: UI保持一致性

### 系统要求
- **Python**: 3.8+
- **操作系统**: Windows 10+, Linux, macOS
- **网络**: 需要互联网连接（在线渲染）
- **内存**: 建议512MB+

## 📝 使用说明

### 快速开始
```bash
# 运行主程序
python main_gui.py

# 测试在线渲染服务
python mermaid_online_tester.py

# 测试特定服务
python test_mermaid_ink.py
```

### 配置建议
```yaml
# 推荐配置（基于测试结果）
mermaid:
  online:
    api_url: https://mermaid.ink/img/
    encoding: base64_url
    timeout: 15
    max_retries: 3
```

## 🚨 已知问题

### 网络相关
- **Mermaid.ink**: 在某些网络环境下连接不稳定
- **Kroki.io**: 服务响应超时问题
- **防火墙**: 企业网络可能阻止API访问

### 解决方案
1. **使用VPN**: 改善网络连接
2. **本地渲染**: 使用portable_nodejs本地渲染
3. **重试机制**: 增加重试次数和超时时间

## 🔮 下一版本计划

### v2.2.0 规划
- 🎯 **本地渲染**: 完善portable_nodejs集成
- 🎯 **缓存系统**: 添加图片缓存减少网络请求
- 🎯 **离线模式**: 支持完全离线工作
- 🎯 **更多API**: 集成更多稳定的渲染服务

## 👥 贡献者

- **主要开发**: AI Assistant
- **测试支持**: 用户反馈
- **技术顾问**: MCU开发社区

## 📞 支持

如果您遇到问题或有建议，请：
1. 查看测试工具输出的诊断信息
2. 检查网络连接和防火墙设置
3. 尝试不同的API配置
4. 考虑使用本地渲染方案

---

**感谢您使用MCU Code Analyzer v2.1.0！** 🎊
